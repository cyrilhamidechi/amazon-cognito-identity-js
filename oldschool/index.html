<html>
    <body onload="initContext(); loadSession();">
        <div id="logme">
            <input type="text" id="login" placeholder="Login" /> | <input type="password" id="pwd" placeholder="Password" /> | <a href="#" onclick="signIn();">Sign in</a>
        </div>
        <div id="s3">
            <h3>My S3 bucket</h3>
            <a href="#" onclick="loadS3();">load my bucket</a>
            <div id="s3content"></div>
        </div>
        <div><a id="loadsession" href="#" onclick="loadSession();">load session</a> | <a id="islogged" href="#" onclick="isLogged();">is logged</a> | <a id="mydetails" href="#" onclick="getMyDetails();">my details</a> | <a id="logout" href="#" onclick="logout();">logout</a></div>
        <script src="./lib/aws-cognito-sdk.min.js"></script>
        <script src="./lib/amazon-cognito-identity.min.js"></script>
        <script src="./lib/aws-sdk.min.js"></script>
        <script src="./s3.js"></script>
        <script src="./../noversion/hardcoded.js"></script>
        <script>

            var COGNITO_CONF = {
              region: 'eu-west-1',
              IdentityPoolId: 'eu-west-1:09cfb9bc-86cf-4aa2-8c0b-dc69614e9527',
              UserPoolId: 'eu-west-1_9JBYfxf8r',
              ClientId: '7328r336bblcg28s42hau13u6c'
            };


            var cognitoUser = null;
            var cognitoUserDetails = null;


            function initContext() {

              cognitoUser = null;
              cognitoUserDetails = null;
              AWS.config.region = COGNITO_CONF.region;
              AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: COGNITO_CONF.IdentityPoolId
              });
              document.getElementById('s3content').innerHTML = '';

            }


            function loadSession() {

              UI.hide('loadsession');

              var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool({
                UserPoolId: COGNITO_CONF.UserPoolId,
                ClientId: COGNITO_CONF.ClientId
              });
              cognitoUser = userPool.getCurrentUser();

              if (!cognitoUser) {
                showLoginForm();
                return;
              }

              cognitoUser.getSession(function (err, session) {
                if (err) {
                  alert(err);
                  return;
                }

                setCreds(session.idToken.jwtToken);

              });

            }


            function showLoginForm() {

              document.getElementById('login').value = USER_CREDS.login;
              document.getElementById('pwd').value = USER_CREDS.pwd;
              UI.hideLoggedMenu();

            }


            function signIn() {

              cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser({
                Username: USER_CREDS.login,
                Pool: new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool({
                  UserPoolId: COGNITO_CONF.UserPoolId,
                  ClientId: COGNITO_CONF.ClientId
                })
              });

              cognitoUser.authenticateUser(new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails({
                Username: document.getElementById('login').value,
                Password: document.getElementById('pwd').value
              }), {
                onSuccess: function (result) {
                  setCreds(result.getIdToken().getJwtToken());
                },
                onFailure: function (err) {
                  alert("Error:" + err);
                }
              });

            }


            function getMyDetails() {

              loadMyDetails(function () {
                for (i = 0; i < cognitoUserDetails.length; i++) {
                  console.log('attribute ' + cognitoUserDetails[i].getName() + ' has value ' + cognitoUserDetails[i].getValue());
                }
              });
            }


            function loadMyDetails(callback) {

              cognitoUser.getUserAttributes(function (err, result) {

                if (err) {
                  UI.hideLoggedMenu();
                  alert(err);
                  return;
                }

                cognitoUserDetails = result;

                if (callback) {
                  callback();
                }

              });

            }


            function logout() {

              UI.hide('logout');

              if (cognitoUser) {
                cognitoUser.signOut();
              }

              initContext();
              isLogged();

            }


            function setCreds(jwtToken) {

              var logins = {}
              logins['cognito-idp.' + COGNITO_CONF.region + '.amazonaws.com/' + COGNITO_CONF.UserPoolId] = jwtToken;

              AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: COGNITO_CONF.IdentityPoolId,
                Logins: logins
              });

              isLogged();

            }


            function isLogged() {

              if (!AWS.config.credentials || !cognitoUser) {
                alert('Not logged');
                UI.hideLoggedMenu();
                return;
              }

              AWS.config.credentials.refresh(function (err, result) {
                console.log(err);
                if (err) {
                  UI.hideLoggedMenu();
                  alert(err);
                  return;
                }
                console.log(result);
                console.log('creds ok');
                UI.showLoggedMenu();
              });

            }


            function loadS3() {
              loadMyDetails(function () {
                initBucket(cognitoUserDetails[0].Value);
//                initBucket(AWS.config.credentials.identityId);
                browse();
              });
            }


            function getHtml(template) {
              return template.join('\n');
            }


            var UI = {
              showLoggedMenu: function () {
                UI.hide('logme');
                UI.hide('loadsession');
                UI.show('s3');
                UI.show('mydetails');
                UI.show('logout');
              },
              hideLoggedMenu: function () {
                UI.show('logme');
                UI.show('loadsession');
                UI.hide('s3');
                UI.hide('mydetails');
                UI.hide('logout');
              },
              show: function (id) {
                UI.toggleDisplay(id, 'inline');
              },
              hide: function (id) {
                UI.toggleDisplay(id, 'none');
              },
              toggleDisplay: function (id, display) {
                document.getElementById(id).style.display = display;
              }

            }


        </script>
    </body>
</html>
